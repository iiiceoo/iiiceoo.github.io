# Kubernetes API

>**REST API** æ˜¯ Kubernetes çš„åŸºæœ¬ç»“æ„ã€‚ Kubernetes æ‰€æœ‰çš„**æ“ä½œ**ä¸ç³»ç»Ÿ**ç»„ä»¶é—´çš„é€šä¿¡**ä»¥åŠ**å¤–éƒ¨ç”¨æˆ·å‘½ä»¤**æœ¬è´¨éƒ½æ˜¯è°ƒç”¨ API Server å¤„ç†çš„ **REST API**ã€‚ å› æ­¤ï¼ŒKubernetes å¹³å°**ä¸‡ç‰©çš† API å¯¹è±¡**ã€‚



## é€šç”¨æ¦‚å¿µ

### API ç‰ˆæœ¬æ§åˆ¶

ä¸åŒçš„ **API ç‰ˆæœ¬**ä»£è¡¨ç€ä¸åŒçš„**ç¨³å®šæ€§**å’Œ**æ”¯æŒçº§åˆ«**ã€‚å¦‚ä¸‹ä¸ºå„çº§åˆ«çš„**æ‘˜è¦**ã€‚

- **Alpha**

  1. ç‰ˆæœ¬åç§°åŒ…å« `alpha`ï¼Œå¦‚ `v1alpha1`ã€‚
  2. è½¯ä»¶å¯èƒ½ä¼šæœ‰ **Bug**ã€‚æŸäº›ç‰¹æ€§å¯èƒ½é»˜è®¤ç¦ç”¨ã€‚
  3. å¯¹æŸä¸ªç‰¹æ€§çš„æ”¯æŒå¯èƒ½ä¼š**éšæ—¶è¢«åˆ é™¤**ã€‚
  4. API å¯èƒ½åœ¨ä»¥åçš„è½¯ä»¶ç‰ˆæœ¬ä¸­ä»¥**ä¸å…¼å®¹çš„æ–¹å¼æ›´æ”¹**ã€‚
  5. ç¼ºé™·**é•¿æœŸæ”¯æŒ**ï¼Œå»ºè®®ä»…ç”¨äºçŸ­æœŸ**æµ‹è¯•é›†ç¾¤**ã€‚

- **Beta**

  1. ç‰ˆæœ¬åç§°åŒ…å« `beta`ï¼Œå¦‚ï¼Œ `v2beta3`ã€‚
  2. è½¯ä»¶è¢«å¾ˆå¥½çš„æµ‹è¯•è¿‡ã€‚å¯ç”¨æŸä¸ªç‰¹æ€§è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œ**ç‰¹æ€§é»˜è®¤å¼€å¯**ã€‚
  3. é•¿æœŸæ”¯æŒã€‚

- **Stable**

  1. ç‰ˆæœ¬åç§°å¦‚ `vX`ï¼Œå…¶ä¸­ `X` ä¸ºæ•´æ•°ï¼Œå¦‚ `v1`ã€‚
  2. ç‰¹æ€§çš„ç¨³å®šç‰ˆæœ¬ä¼šå‡ºç°åœ¨åç»­å¾ˆå¤šç‰ˆæœ¬çš„å‘å¸ƒè½¯ä»¶ä¸­ã€‚



### API ç»„

API ç»„èƒ½å¤Ÿç®€åŒ–å¯¹ Kubernetes API çš„æ‰©å±•ã€‚ API ç»„ä¿¡æ¯å‡ºç°åœ¨ **REST è·¯å¾„**ä¸­ï¼Œä¹Ÿå‡ºç°åœ¨åºåˆ—åŒ–å¯¹è±¡çš„ `apiVersion` å­—æ®µä¸­ã€‚API ç»„å¯å¤§è‡´åˆ†ä¸ºä¸¤ç±»ã€‚

- **æ ¸å¿ƒç»„**ï¼ˆä¹Ÿç§° *legacy*ï¼‰ï¼šå…¶ REST è·¯å¾„ä¸º `/api/vi`ã€‚åŒæ—¶ï¼Œæ ¸å¿ƒç»„å¹¶ä¸ä½œä¸º `apiVersion` å­—æ®µçš„ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚åœ¨**èµ„æºæ¸…å•**ä¸­è§çš„éå¸¸å¤šçš„ `apiVersion: v1`ã€‚*Pod*ï¼Œ*Node*ï¼Œ*Volume*ï¼Œ*Service* ç­‰ï¼Œéƒ½æ˜¯å¸¸è§çš„**æ ¸å¿ƒç»„èµ„æº**ã€‚
- **æ™®é€šç»„**ï¼šä¸åŒäº**æ ¸å¿ƒç»„**çš„æœ€å¤§ç‰¹ç‚¹**æ— åˆ†ç»„**ï¼Œ**æ™®é€šç»„**å³**å…·æœ‰åˆ†ç»„ä¿¡æ¯çš„ç»„**ã€‚å…¶ REST è·¯å¾„ä¸º `/apis/$GROUP_NAME/$VERSION`ï¼ŒåŒæ—¶åœ¨åºåˆ—åŒ–å¯¹è±¡ä¸­ä½¿ç”¨ `apiVersion: $GROUP_NAME/$VERSION` ï¼Œå¦‚ `apiVersion: batch/v1`ã€‚



å¯ä»¥æŸ¥çœ‹ Kubernetes é¡¹ç›®ä¸‹çš„ **pkg** ç›®å½•ï¼ˆå­˜æ”¾ Kubernetes API å¯¹è±¡çš„ç›®å½•ï¼‰ã€‚

![image-20210610113145622](./img/image-20210610113145622.png)

**API ç»„**å’Œ **API ç‰ˆæœ¬**çš„ä½œç”¨ä¸€ç›®äº†ç„¶ï¼Œ**v1** æˆ– **v1beta1** æ–‡ä»¶å¤¹ä¸‹å°±æ˜¯**ç›¸åº”ç‰ˆæœ¬**çš„ API å¯¹è±¡çš„ä»£ç äº†ã€‚è¿™ç§è®¾è®¡ä½¿å¾— Kubernetes API çš„æ‰©å±•å˜å¾—éå¸¸å®¹æ˜“ã€‚



### æ ‡å‡† API æœ¯è¯­

å¤§å¤šæ•° Kubernetes API èµ„æºç±»å‹éƒ½æ˜¯å¯¹è±¡ï¼šå®ƒä»¬ä»£è¡¨çš„æ˜¯é›†ç¾¤ä¸­æŸä¸€æ¦‚å¿µçš„**å…·ä½“å®ä¾‹**ï¼Œä¾‹å¦‚ä¸€ä¸ª *Pod* æˆ– *Namespace*ã€‚

Kubernetes ä¸€èˆ¬ä¼šåˆ©ç”¨æ ‡å‡†çš„ **RESTful æœ¯è¯­**æ¥æè¿° API æ¦‚å¿µï¼š

- **èµ„æºç±»å‹ï¼ˆResource Typeï¼‰** æ˜¯åœ¨ URL ä¸­ä½¿ç”¨çš„åç§°ï¼ˆ`pods`ï¼Œ`namespaces`ï¼Œ`services` ç­‰ï¼‰ã€‚
- æ‰€æœ‰èµ„æºç±»å‹éƒ½æœ‰å…·æœ‰ä¸€ä¸ª JSON å½¢å¼ï¼ˆå…¶å¯¹è±¡çš„**æ¨¡å¼å®šä¹‰**ï¼‰çš„å…·ä½“è¡¨ç¤ºï¼Œç§°ä½œ**ç±»åˆ«ï¼ˆKindï¼‰**ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ç¼–å†™ **Yaml æ ¼å¼çš„æ–‡ä»¶**æ¥å®šä¹‰å’Œæè¿°æƒ³è¦æ“ä½œçš„èµ„æºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„**èµ„æºæ¸…å•**ã€‚
- æŸèµ„æºç±»å‹çš„å®ä¾‹çš„åˆ—è¡¨ç§°ä½œ**é›†åˆï¼ˆCollectionï¼‰**ã€‚
- èµ„æºç±»å‹çš„å•ä¸ªå®ä¾‹è¢«ç§°ä½œ**èµ„æºï¼ˆResourceï¼‰**ã€‚



æ‰€æœ‰èµ„æºç±»å‹è¦ä¹ˆæ˜¯**é›†ç¾¤ä½œç”¨åŸŸ**çš„ï¼ˆ`/apis/GROUP/VERSION/*`ï¼‰ï¼Œè¦ä¹ˆæ˜¯**åå­—ç©ºé—´ä½œç”¨åŸŸ**çš„ï¼ˆ`/apis/GROUP/VERSION/namespaces/NAMESPACE/*`ï¼‰ã€‚åå­—ç©ºé—´ä½œç”¨åŸŸçš„èµ„æºç±»å‹ä¼šåœ¨å…¶**åå­—ç©ºé—´è¢«åˆ é™¤æ—¶ä¹Ÿè¢«åˆ é™¤**ã€‚

ä¸€ä¸ªç®€å•ä¾‹å­ï¼Œå¯ç”¨ä¸‹åˆ—è·¯å¾„æ¥**æ£€è§†é›†åˆå’Œèµ„æº**ï¼š

- **é›†ç¾¤ä½œç”¨åŸŸçš„èµ„æº**ï¼š
  1. `GET /apis/GROUP/VERSION/RESOURCETYPE` - è¿”å›æŒ‡å®šèµ„æºç±»å‹çš„èµ„æºçš„é›†åˆã€‚
  2. `GET /apis/GROUP/VERSION/RESOURCETYPE/NAME` - è¿”å›æŒ‡å®šèµ„æºç±»å‹ä¸‹åç§°ä¸º **NAME** çš„èµ„æºã€‚
- **åå­—ç©ºé—´ä½œç”¨åŸŸçš„èµ„æº**ï¼š
  1. `GET /apis/GROUP/VERSION/RESOURCETYPE` - è¿”å›æ‰€æœ‰åå­—ç©ºé—´ä¸­æŒ‡å®šèµ„æºç±»å‹çš„å…¨éƒ¨å®ä¾‹çš„é›†åˆã€‚
  2. `GET /apis/GROUP/VERSION/namespaces/NAMESPACE/RESOURCETYPE` - è¿”å›åå­—ç©ºé—´ **NAMESPACE** å†…ç»™å®šèµ„æºç±»å‹çš„å…¨éƒ¨å®ä¾‹çš„é›†åˆã€‚
  3. `GET /apis/GROUP/VERSION/namespaces/NAMESPACE/RESOURCETYPE/NAME` - è¿”å›åå­—ç©ºé—´ **NAMESPACE** ä¸­ç»™å®šèµ„æºç±»å‹çš„åç§°ä¸º **NAME** çš„å®ä¾‹ã€‚

å‡ ä¹æ‰€æœ‰å¯¹è±¡èµ„æºç±»å‹éƒ½æ”¯æŒæ ‡å‡†çš„ **HTTP åŠ¨è¯**ï¼ˆ`GET`ï¼Œ`PUT`ï¼Œ`POST`ï¼Œ`PATCH` å’Œ `DELETE`ï¼‰æ¥è¿›è¡Œ**æ£€è§†**ï¼Œ**åˆ›å»º**ï¼Œ**æ›´æ–°**å’Œ**åˆ é™¤**ã€‚åŒæ—¶ï¼ŒKubernetes ä¸­ä½¿ç”¨æœ¯è¯­ **LIST** æ¥æè¿°**è¿”å›èµ„æºé›†åˆçš„æ“ä½œ**ï¼Œä»¥ä¾¿ä¸**è¿”å›å•ä¸ªèµ„æºçš„**ï¼Œé€šå¸¸ç§°ä½œ **GET** çš„æ“ä½œç›¸åŒºåˆ†ã€‚



ç°åœ¨æˆ‘ä»¬åº”è¯¥èƒ½ç†è§£ Kubernetes API å®é™…ä¸Šå°±æ˜¯**åŸºäºèµ„æºçš„**ï¼Œé€šè¿‡ **HTTP** æä¾›çš„**ç¼–ç¨‹æ¥å£**ã€‚Kubernetes å¹³å°çš„ä»»ä½•èƒ½åŠ›ï¼Œå…¶å®éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªä¸ªçš„ **API å¯¹è±¡**æ‰€è¡¨ç°å‡ºæ¥çš„ï¼Œå¼€å‘è€…èƒ½åšçš„å°±æ˜¯é€šè¿‡ Kubernetes API å»**æ“ä½œ**ï¼Œ**è°ƒæ•´**è¿™äº› API å¯¹è±¡ï¼Œç„¶åé€šè¿‡**æ§åˆ¶å¾ªç¯**æ¥ä½¿æ•´ä¸ªé›†ç¾¤ä¸æ–­çš„è¶‹å‘äº**æœŸæœ›çŠ¶æ€**ã€‚

å¥½æ¯”å½“æˆ‘ä»¬æƒ³æè¿°ä¸€ä¸ªå¯æ‰©ç¼©å®¹çš„åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ *Deployment*ï¼›éœ€è¦æš´éœ²ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œæˆ‘ä»¬åˆ›å»º *Service*ã€‚è€Œå½“ Kubernetes å¹³å°**åŸç”Ÿçš„ API å¯¹è±¡**å·²ç»æè¿°ä¸äº†å¼€å‘è€…çš„**ä¸šåŠ¡åœºæ™¯**æ—¶ï¼Œä¹Ÿå°±æœ‰äº† *CRD*ï¼ˆCustom Resource Definitionï¼‰ã€‚



[Kubernetes API æ–‡æ¡£ï¼ˆv1.21ï¼‰](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#-strong-api-overview-strong-)å°±å±•ç¤ºå‡ºäº†éå¸¸é²œæ˜çš„**å£°æ˜å¼ API** ç‰¹ç‚¹ã€‚ç›¸è¾ƒäºä¼ ç»Ÿç”¨çš„**å‘½ä»¤å¼ API** æ–‡æ¡£ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä»½å„ç±» **API å¯¹è±¡**çš„**å­—å…¸**ï¼Œå…¶ä¸­è¯¦ç»†çš„è®°å½•äº†æ¯ä¸ª **API å¯¹è±¡**çš„**å­—æ®µ**åŠå…¶**æ•ˆæœ**ã€‚

![image-20210610142715097](./img/image-20210610142715097.png)




### å®¢æˆ·ç«¯åº“

åœ¨ä½¿ç”¨ **Kubernetes REST API** ç¼–å†™åº”ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„**ç¼–ç¨‹è¯­è¨€**éœ€è¦é€‰æ‹©ä½¿ç”¨åˆé€‚çš„**å®¢æˆ·ç«¯åº“**ã€‚

| è¯­è¨€   | å®¢æˆ·ç«¯åº“                                                     | æ ·ä¾‹ç¨‹åº                                                     |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Go     | [github.com/kubernetes/client-go/](https://github.com/kubernetes/client-go/) | [ğŸ”—](https://github.com/kubernetes/client-go/tree/master/examples) |
| Python | [github.com/kubernetes-client/python/](https://github.com/kubernetes-client/python/) | [ğŸ”—](https://github.com/kubernetes-client/python/tree/master/examples) |
| Java   | [github.com/kubernetes-client/java](https://github.com/kubernetes-client/java/) | [ğŸ”—](https://github.com/kubernetes-client/java#installation)  |



## HTTP REST API è®¿é—®

Kubernetes é›†ç¾¤æ­å»ºä¹‹åï¼Œé™¤äº†ä½¿ç”¨å®˜æ–¹çš„ kubectl å·¥å…·ä¸ API Server è¿›è¡Œäº¤äº’ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ Postman å·¥å…·æˆ–è€… curl å‘½ä»¤ï¼Œè¿™æ ·ä¸ä½†å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†Ÿæ‚‰ **Kubernetes REST API**ï¼Œæœ‰äº›æ—¶å€™ç›´æ¥ä½¿ç”¨ Postman æˆ– curl **åŠŸèƒ½ä¼šæ›´å¼ºå¤§**ã€‚

è€Œä¸ API Server äº¤äº’é€šå¸¸éœ€è¦ä¸€ä¸ªæœ‰æ­£ç¡®æƒé™çš„ *ServiceAccount*ï¼Œè¯¥ *ServiceAccount* é€šè¿‡ *ClusterRole*/*Role*ï¼Œ*ClusterRoleBinding*/*RoleBinding* ç»™å…¶èµ‹äºˆç›¸å…³èµ„æºçš„**æ“ä½œæƒé™**ï¼Œ*ServiceAccount* å¯¹åº”çš„ **Token** åˆ™ç”¨äº API Server è¿›è¡ŒåŸºæœ¬çš„**è®¤è¯**ã€‚



### curl

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º `apiviewer` çš„ *ServiceAccount*ã€‚

```bash
kubectl create sa apiviewer
```

![image-20210610145552385](./img/image-20210610145552385.png)



æŸ¥çœ‹è¿™ä¸ª *ServiceAccount* å¯¹åº”çš„ *Secret* åç§°ã€‚

```bash
kubectl get sa/apiviewer -o yaml
```

![image-20210610145747058](./img/image-20210610145747058.png)



æŸ¥çœ‹è¿™ä¸ª *Secret* çš„æ•°æ®ã€‚

```bash
kubectl get secret/apiviewer-token-7hcs7 -o yaml
```

![image-20210610150337360](./img/image-20210610150337360.png)



åˆ›å»ºä¸€ä¸ª *ClusterRoleBinding*ï¼Œå°†ç³»ç»Ÿé¢„ç•™è§’è‰² **cluster-admin** åˆ†é…ç»™ **apiviewer**ã€‚

```bash
kubectl create clusterrolebinding apiadmin --clusterrole cluster-admin --serviceaccount default:apiviewer
```

![image-20210610150747247](./img/image-20210610150747247.png)



è·å– *Secret* ä¸­çš„ **Bearer Token**ã€‚

```bash
TOKEN=$(kubectl get secret/apiviewer-token-7hcs7 -o jsonpath='{.data.token}' | base64 -d)
```

ç„¶åæˆ‘ä»¬æŠŠ**è¯ä¹¦**ä¹Ÿæå–å‡ºæ¥ã€‚

```bash
kubectl get secret/apiviewer-token-7hcs7 -o jsonpath="{.data['ca\.crt']}" | base64 -d > ca.crt
```

![image-20210610151626577](./img/image-20210610151626577.png)



è·å– API Server URLã€‚

```bash
APISERVER=https://$(kubectl get endpoints/kubernetes --no-headers | awk '{ print $2 }' | cut -d "," -f 1)
```

![image-20210610151913559](./img/image-20210610151913559.png)



ç°åœ¨æˆ‘ä»¬é€šè¿‡ `curl` å‘½ä»¤æŸ¥è¯¢ **default** *namespace* ä¸‹çš„æ‰€æœ‰ *Pod*ã€‚

```bash
curl -s $APISERVER/api/v1/namespaces/default/pods/ \
--header "Authorization: Bearer $TOKEN" \
--cacert ca.crt
```

![image-20210610152323701](./img/image-20210610152323701.png)





### Postman

å¦‚æœè¦ä½¿ç”¨ Postman å·¥å…·è®¿é—® API Serverï¼Œè¿‡ç¨‹å…¶å®ä¸ curl å¤§åŒå°å¼‚ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä¹‹å‰ *Secret* ä¸­æå–å‡ºçš„**è¯ä¹¦**æ‹·è´è‡³ windowsã€‚åŒå‡» **.crt æ–‡ä»¶**ã€‚

![image-20210610154021113](./img/image-20210610154021113.png)



åœ¨ Postman å·¥å…·ä¸­æ–°å»ºä¸€ä¸ª**æ ‡ç­¾**ï¼Œè¾“å…¥ API Server çš„**è¯·æ±‚è·¯å¾„**ã€‚ç‚¹å‡»ä¸‹æ–¹çš„ **Authorization**ï¼Œé€‰æ‹© **Bearer Token** çš„ **Type**ï¼Œç„¶ååœ¨å³ä¾§çš„ **Token** ä¸­è¾“å…¥æˆ‘ä»¬ä¹‹å‰è·å–åˆ°çš„ *Secret* ä¸­çš„ **Token**ã€‚

![image-20210610154555280](./img/image-20210610154555280.png)



è¯·æ±‚ API Serverï¼Œå¯ä»¥çœ‹åˆ°è¯·æ±‚å¤´ä¸­å·²ç»åŠ ä¸Šäº†æˆ‘ä»¬åˆšè®¾ç½®çš„ **Authorization** å‚æ•°ï¼Œä¸”è¯·æ±‚æˆåŠŸå“åº”ã€‚

![image-20210610154818744](./img/image-20210610154818744.png)











